
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="./node_modules/jspdf/dist/jspdf.umd.min.js"></script>
    <script src="./node_modules/html2canvas/dist/html2canvas.min.js"></script>
    <script src="./foldervreater.js"></script>
    <script src="./createInputTableToter.js"></script>
    <script src="./clearthecolorer.js"></script>
    <script src="./Teammateadder.js"></script>
    <script src="./adding_team.js"></script>

    <title>Fill Table</title>
    <link rel="stylesheet" type="text/css" href="styles.css">
</head>
<body>
    <div id="folderCreation">
        <input type="text" id="folderName" placeholder="Enter folder name">
        <button onclick="createFolder()">Create Folder</button>
    </div>
<div id="tableSize">
    <label for="rows">Rows:</label>
    <input type="number" id="num-rows" min="1" value="1" />
    <label for="cols">Columns:</label>
    <input type="number" id="num-cols" min="1" value="1"/>
    <button onclick="createInputTableTo('table-container')">
        Create Table
    </button>
</div>
<div id="interface1" class="hidden">
    <h2>Enter Teammate Information</h2>
    <label for="teammateName">Teammate Name:</label>
    <input type="text" id="teammateName" />
    <h3>班數的上限與下限</h3> 
    <label for="inputX">下限:</label>
    <input type="number" id="inputX" name="inputX" min="0" value="0">
    <label for="inputY">上限:</label>
    <input type="number" id="inputY" name="inputY" min="1" value="1">
    <button id="toggleButton" >going to select the blocked</button>
    <button onclick="addTeammate()" class="hidden" id="adding_teammates">add teammates</button>
    <br />
    <p>Blocked Cells:</p>
    <div id="table-container"></div>
   
 
</div>
<div id="interface3"  class="hidden">
    <h2>Filled Table</h2>
    <button onclick="fillTable(0,0)">Fill Table</button>
    <button onclick="showRandomResult()">Show Random Result</button>
    <table id="table"></table>
</div>


<div id="teammate-list"></div>
<div id="clearweirdcolor">
<button onclick="clearthecolor()">clear the color</button>
</div>

<script>

document.getElementById("toggleButton").addEventListener("click", function() {
    document.getElementById('adding_teammates').style.display = 'block'; 
    var cells = document.querySelectorAll("#teammate-table td");
    cells.forEach(function(cell) {
        cell.addEventListener("click", function() {
        var jj=[cell.cellIndex,cell.parentElement.rowIndex,];
            if (cell.style.backgroundColor === "gray") {
                cell.style.backgroundColor = "white";
                currentSelectedCells = currentSelectedCells.filter(function(subArray) {
                    return JSON.stringify(subArray) !== JSON.stringify(jj);
                });
            } else {
                cell.style.backgroundColor = "gray";
                currentSelectedCells.push(jj);
            }
        });
    });
});
    let teammates = [];
    let blockedCells = [];
    let tableData = [];
    let awaysblockcell=[];
    let currentSelectedCells = [];
    let numRows;
    let numCols;    
    let shiftd;
    let shiftu;


    function updateTeammateList() {
        const teammateListContainer = document.getElementById("teammate-list");
        teammateListContainer.innerHTML = ""; // Clear previous list

        teammates.forEach((teammate, index) => {
            const teammateNameElement = document.createElement("div");
            teammateNameElement.classList.add("teammate-name");
            teammateNameElement.textContent ="name:"+teammate.name+" shift:"+teammate.shiftd+"\~"+teammate.shiftu;
            teammateNameElement.onclick = function () {
                // Highlight blocked cells
                highlightBlockedCells(teammate.blocked);
            };
            teammateListContainer.appendChild(teammateNameElement);
        });
    }

    function highlightBlockedCells(blockedCells) {
        const table = document.getElementById("teammate-table");

        table.querySelectorAll("td").forEach((cell) => {
            cell.style.backgroundColor = ""; // Reset background color
        });

        blockedCells.forEach(([col, row]) => {
            table.rows[row].cells[col].style.backgroundColor = "gray";
        
        });
    }

function fillTable(x,y) {
    const table = document.getElementById("teammate-table");
    const cell = table.rows[y].cells[x];
 
    for(let i=0;i<teammates.length;i++) {
        w=true;
    if(teammates[i].shiftnow>=teammates[i].shiftu) {
          w=false;
            continue;
      }
       
        for(ii=0;ii<teammates[i].blocked.length&&w;ii++) {
            arr1=([cell.cellIndex, cell.parentElement.rowIndex]);
            arr2=teammates[i].blocked[ii];
            w=!(arr1.every((value, index) => value === arr2[index]));
        } 
        if(w) {
         //   console.log([cell.cellIndex, cell.parentElement.rowIndex]);  
            cell.innerHTML=teammates[i].name;
            teammates[i].shiftnow++;
            if(y<numRows-1) fillTable (x,y+1);
            else if (x<numCols-1) fillTable(x + 1, 0);
            else if (x ===numCols-1 && y === numRows-1) {
                generate();
            }
           teammates[i].shiftnow--;
        }
        cell.innerHTML="";
        
    }

}

    function generate() {
        var tableHtml= "<table border='1'>";
        
        tableHtml+=document.getElementById("teammate-table").innerHTML;
        tableHtml+="</table>";
    // var blob = new Blob([tableHtml], { type: "text/html" });
        fetch('/savetable', {
        method: 'POST',
        headers: {
        'Content-Type': 'application/json'
        },
        body: JSON.stringify({ pdfData: tableHtml })
        })
        .then(response => {
            if (!response.ok) {
            throw new Error('Failed to send table data.');
            }
           return response.json();
        })
        .then(data => {
           console.log(data.message); // 顯示成功消息
        })
        .catch(error => {
            console.error(error);
          alert('Failed to send table data.');
        });

    /*
        var url = URL.createObjectURL(blob);
        
        var a = document.createElement("a");
        a.href = url;
        a.download = "table.html";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);    


*/
    /*
        var request = indexedDB.open(document.getElementById("folderName"));
        request.onerror = function(event) {
            console.error('IndexedDB error:', event.target.error);
        };
        request.onsuccess = function(event) {
            console.log('IndexedDB opened successfully.');
            var db = event.target.result;

            // 創建交易
            var transaction = db.transaction(['teamates'], 'readwrite');
            var objectStore = transaction.objectStore('teamates');

            // 獲取表格 HTML 內容
            var tableHtml = document.getElementById("teammate-table").innerHTML;

            // 將表格 HTML 存儲到 IndexedDB 中
            var request = objectStore.add({ html: tableHtml });

            request.onsuccess = function(event) {
                console.log('Table HTML saved to IndexedDB.');
            };

            request.onerror = function(event) {
                console.error('Error saving table HTML to IndexedDB:', event.target.error);
            };
        };

    */
    };



    

    function showRandomResult() {
        // To be implemented
    }
</script>
</body>
</html>



